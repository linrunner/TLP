#!/usr/bin/env clitest
# Test charge thresholds for laptops with Wilco EC
# Requirements:
# * Software: kernel module wilco_charger (Linux 5.9+)
# Copyright (c) 2026 Thomas Koch <linrunner at gmx.net>.
# SPDX-License-Identifier: GPL-2.0-or-later
#
$ # +++ laptops with Wilco EC +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
$ #
$ # --- tlp start
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0= STOP_CHARGE_THRESH_BAT0= START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="60" STOP_CHARGE_THRESH_BAT0="100" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="100" STOP_CHARGE_THRESH_BAT0="100" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
Error in configuration at START_CHARGE_THRESH_BAT0="100": not specified, invalid or out of range (50..95). Skipped.
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="50" STOP_CHARGE_THRESH_BAT0="0" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
Error in configuration at STOP_CHARGE_THRESH_BAT0="0": not specified, invalid or out of range (55..100). Skipped.
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="50" STOP_CHARGE_THRESH_BAT0="101" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
Error in configuration at STOP_CHARGE_THRESH_BAT0="101": not specified, invalid or out of range (55..100). Skipped.
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="90" STOP_CHARGE_THRESH_BAT0="91" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
Error in configuration: START_CHARGE_THRESH_BAT0 > STOP_CHARGE_THRESH_BAT0 - 5. Skipped.
TLP started
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="90" STOP_CHARGE_THRESH_BAT0="95" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
TLP started
$ [ -n "${xinc}" ] && [ -n "$VWRITE_SLEEP" ] && sleep "$VWRITE_SLEEP" # workaround: mitigate void writes (in simulation)
$ sudo tlp start -- ${xinc} START_CHARGE_THRESH_BAT0="DEF" STOP_CHARGE_THRESH_BAT0="DEF" START_CHARGE_THRESH_BAT1= STOP_CHARGE_THRESH_BAT1= 2>&1 | sed -r "s/(TLP started).*/\1/"
TLP started
$ sudo tlp start -- ${xinc} NATACPI_ENABLE=0 START_CHARGE_THRESH_BAT0="DEF" STOP_CHARGE_THRESH_BAT0="DEF" 2>&1 | sed -r "s/(TLP started).*/\1/"
TLP started
$ #
$ # --- tlp setcharge w/o arguments
$ [ -n "${xinc}" ] && [ -n "$VWRITE_SLEEP" ] && sleep "$VWRITE_SLEEP" # workaround: mitigate void writes (in simulation)
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="60" STOP_CHARGE_THRESH_BAT0="100" X_SOC_CHECK=0
Setting temporary charge thresholds:
  start =  60
  stop  = 100 (no change)
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="100" STOP_CHARGE_THRESH_BAT0="100"
Error in configuration at START_CHARGE_THRESH_BAT0="100": not specified, invalid or out of range (50..95). Aborted.
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="50" STOP_CHARGE_THRESH_BAT0="0"
Error in configuration at STOP_CHARGE_THRESH_BAT0="0": not specified, invalid or out of range (55..100). Aborted.
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="50" STOP_CHARGE_THRESH_BAT0="101"
Error in configuration at STOP_CHARGE_THRESH_BAT0="101": not specified, invalid or out of range (55..100). Aborted.
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="90" STOP_CHARGE_THRESH_BAT0="91"
Error in configuration: START_CHARGE_THRESH_BAT0 > STOP_CHARGE_THRESH_BAT0 - 5. Aborted.
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="90" STOP_CHARGE_THRESH_BAT0="95"
Setting temporary charge thresholds:
  start =  90
  stop  =  95
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="90" STOP_CHARGE_THRESH_BAT0="95"
Setting temporary charge thresholds:
  start =  90 (no change)
  stop  =  95 (no change)
$ sudo tlp setcharge -- ${xinc} START_CHARGE_THRESH_BAT0="DEF" STOP_CHARGE_THRESH_BAT0="DEF"
Setting temporary charge thresholds:
  stop  = 100
  start =  95
$ sudo tlp setcharge -- ${xinc} NATACPI_ENABLE=0 START_CHARGE_THRESH_BAT0="DEF" STOP_CHARGE_THRESH_BAT0="DEF"
Error: there is no hardware driver support for charge thresholds.
$ #
$ # --- tlp setcharge w/ arguments
$ sudo tlp setcharge 60 100 -- ${xinc} X_SOC_CHECK=0
Setting temporary charge thresholds:
  start =  60
  stop  = 100 (no change)
$ sudo tlp setcharge 61 99 -- ${xinc} X_THRESH_SIMULATE_WRITEERR=1 X_SOC_CHECK=0
Setting temporary charge thresholds:
  start =  61 (Error: write failed)
  stop  =  99 (Error: write failed)
$ sudo tlp setcharge 100 100 -- ${xinc}
Error: start charge threshold (100) is not specified, invalid or out of range (50..95). Aborted.
$ sudo tlp setcharge 50 0 -- ${xinc}
Error: stop charge threshold (0) is not specified, invalid or out of range (55..100). Aborted.
$ sudo tlp setcharge 50 101 -- ${xinc}
Error: stop charge threshold (101) is not specified, invalid or out of range (55..100). Aborted.
$ sudo tlp setcharge XYZZY 0 -- ${xinc}
Error: start charge threshold (XYZZY) is not specified, invalid or out of range (50..95). Aborted.
$ sudo tlp setcharge 50 XYZZY -- ${xinc}
Error: stop charge threshold (XYZZY) is not specified, invalid or out of range (55..100). Aborted.
$ sudo tlp setcharge 90 91 -- ${xinc}
Error: start threshold > stop threshold - 5. Aborted.
$ [ -n "${xinc}" ] && [ -n "$VWRITE_SLEEP" ] && sleep "$VWRITE_SLEEP" # workaround: mitigate void writes (in simulation)
$ sudo tlp setcharge 90 95 -- ${xinc}
Setting temporary charge thresholds:
  start =  90
  stop  =  95
$ sudo tlp setcharge 90 95 -- ${xinc} X_THRESH_SIMULATE_READERR="1"
Error: could not read current charge threshold(s). Aborted.
$ [ -n "${xinc}" ] && [ -n "$VWRITE_SLEEP" ] && sleep "$VWRITE_SLEEP" # workaround: mitigate void writes (in simulation)
$ sudo tlp setcharge 90 95 -- ${xinc} X_THRESH_SIMULATE_START="60" X_THRESH_SIMULATE_STOP="100"
Setting temporary charge thresholds:
  start =  90
  stop  =  95
$ sudo tlp setcharge 90 95 -- ${xinc}
Setting temporary charge thresholds:
  start =  90 (no change)
  stop  =  95 (no change)
$ sudo tlp setcharge DEF DEF -- ${xinc}
Setting temporary charge thresholds:
  stop  = 100
  start =  95
$ sudo tlp setcharge BAT2 -- ${xinc}
Error: battery BAT2 not present.
$ sudo tlp setcharge 0 3 BAT2 -- ${xinc}
Error: battery BAT2 not present.
$ sudo tlp setcharge XYZZY ABCDE BAT2 -- ${xinc}
Error: battery BAT2 not present.
$ #
$ # --- tlp-stat
$ sudo tlp-stat -b -- ${xinc} | grep -E 'wilco-charger/charge_control'
/sys/class/power_supply/wilco-charger/charge_control_start_threshold  =     95 [%]
/sys/class/power_supply/wilco-charger/charge_control_end_threshold    =    100 [%]
$ sudo tlp-stat -b -- ${xinc} X_THRESH_SIMULATE_READERR=1 | grep -E 'wilco-charger/charge_control'
/sys/class/power_supply/wilco-charger/charge_control_start_threshold  = (not available) [%]
/sys/class/power_supply/wilco-charger/charge_control_end_threshold    = (not available) [%]
$ #
$ # --- Reset test machine to configured thresholds
$ sudo tlp setcharge BAT0 - ${xinc} > /dev/null 2>&1
$ #
